generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------------
// 基本エンティティ（継承はテーブル間のリレーションで実現）
// -------------------------------------------------
model Employee {
  id            String   @id @default(uuid())
  employeeNumber String   @unique
  name          String
  email         String   @unique
  companyName   String?
  department    String?
  phoneNumber   String?   // "000-0000-0000" フォーマット（バリデーションはアプリ側で実装）

  nurse         Nurse?

  reservations  Reservation[]   @relation("PatientReservations")
}

model Doctor {
  id                      Int      @id @default(autoincrement())
  name                    String
  email                   String   @default("")
  azureObjectId           String   @default("")
  honorific               String   @default("医師")
  minDurationMinutes      Int      @default(5)
  defaultDurationMinutes  Int      @default(30)
  maxDurationMinutes      Int      @default(300)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  schedules          DoctorSchedule[]
  reservations       Reservation[] @relation("DoctorReservations")
}

model Nurse {
  id         String   @id @default(uuid())
  employeeId String   @unique
  employee   Employee @relation(fields: [employeeId], references: [id])
  title      String?
  reservations Reservation[] @relation("NurseReservations")
  // 看護師は予約に必ずしも紐付かないので、Reservation 側は nullable にしておく
}

model DoctorSchedule {
  id               String   @id @default(uuid())
  doctorId         Int
  doctor           Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  date             String   // YYYY-MM-DD 形式
  timePeriods      Json     // [{startTime: "HH:mm", endTime: "HH:mm"}, ...] 形式の JSON
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([doctorId, date]) // 同一医師・同一日の重複ブロック防止
}

model Reservation {
  id            String   @id @default(uuid())
  doctorId      Int
  employeeId    String
  nurseId       String?   // 必須ではない
  startUtc      DateTime
  endUtc        DateTime

  doctor        Doctor   @relation("DoctorReservations", fields: [doctorId], references: [id], onDelete: Cascade)
  employee      Employee @relation("PatientReservations", fields: [employeeId], references: [id], onDelete: Cascade)
  nurse         Nurse?   @relation("NurseReservations", fields: [nurseId], references: [id], onDelete: SetNull)
  reminderSents ReminderSent[]

  // 将来的にステータス管理したいときのためのフィールド（現時点では未使用）
  status        String?   @default("PENDING")
}

model Workday {
  id          String @id @default(uuid())
  dayOfWeek   Int    // 0=Sun … 6=Sat
}

// メールテンプレート（リマインダー用は「Reminder」名前で登録想定）
model EmailTemplate {
  id      String @id @default(uuid())
  name    String @unique
  subject String
  body    String   // Mustache / Handlebars 形式の文字列
}

// リマインダー設定（X日前・YY時に送信）
model ReminderConfig {
  id          String @id @default(uuid())
  daysBefore  Int    // 例: 3 → 予約日の 3日前
  sendHour    Int    // 0‑23 (UTC)
  sentRecords ReminderSent[]
}

// リマインダー送信履歴（二重送信防止用）
model ReminderSent {
  id            String @id @default(uuid())
  reservationId String
  configId      String
  sentAtUtc     DateTime @default(now())

  reservation   Reservation    @relation(fields: [reservationId], references: [id])
  config        ReminderConfig @relation(fields: [configId], references: [id])

  @@unique([reservationId, configId]) // 同一予約・設定の重複送信防止
}

// ユーザータイムゾーン（フロント側で表示変換に使用）
model UserTimezone {
  userId   String @id        // Azure AD の Object ID と同一
  timezone String               // IANA タイムゾーン文字列例: "Asia/Tokyo"
}

// システム設定
model SystemConfig {
  id                    String @id @default(uuid())
  minScreenWidth        Int    @default(1024)     // 画面最小幅（ピクセル）
  minScreenHeight       Int    @default(768)      // 画面最小高さ（ピクセル）
  displayDaysOfWeek     Int[]  @default([0, 1, 2, 3, 4, 5, 6])  // カレンダーに表示する曜日
  // 診療時間帯：曜日ごとの診療開始・終了時刻（JSON形式）
  // [{dayOfWeek: 0, startTime: "09:00", endTime: "18:00"}, ...]
  clinicHours           Json   @default("[]")
  numberOfExaminationRooms Int  @default(1)     // 診察室の部屋数
  doctorDefaultDurationMinutes Int @default(30) // 医師のデフォルト診察時間
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// 将来的に健康診断結果テーブル（現在は未利用）
// model HealthCheckResult {
//   id          String   @id @default(uuid())
//   employeeId  String
//   checkDate   DateTime
//   bloodPressure String?
//   bloodSugar    String?
//   // ...その他項目
//   employee   Employee @relation(fields: [employeeId], references: [id])
// }
